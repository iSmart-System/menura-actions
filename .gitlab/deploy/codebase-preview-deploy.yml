# =============================================================================
# Preview Deploy to Sandbox (Reusable Pipeline)
# =============================================================================
# Pipeline reutiliz√°vel para preview deploys manuais em Merge Requests.
# Cria environments nativos com auto-cleanup e dispara pipeline no
# cloud-foundation via GitLab Pipeline Triggers (100% nativo!).
# =============================================================================

.preview-deploy-base:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache curl jq bash
  script:
    - |
      echo "üöÄ Disparando preview deploy"

      # Validar inputs obrigat√≥rios
      if [ -z "$ARTIFACT_NAME" ]; then
        echo "‚ùå ARTIFACT_NAME n√£o definido"
        echo "Configure: variables.ARTIFACT_NAME no seu .gitlab-ci.yml"
        exit 1
      fi

      if [ -z "$CI_MERGE_REQUEST_IID" ]; then
        echo "‚ùå Apenas dispon√≠vel em Merge Requests"
        exit 1
      fi

      # Preparar metadata
      PREVIEW_ID="mr-$CI_MERGE_REQUEST_IID"
      EPHEMERAL_ARTIFACT="$ARTIFACT_NAME-mr-$CI_MERGE_REQUEST_IID"

      echo "üìã Metadata do Preview Deploy:"
      echo "  - Preview ID: $PREVIEW_ID"
      echo "  - Artefato: $EPHEMERAL_ARTIFACT"
      echo "  - Foundation: m3nura/cloud-foundation"
      echo "  - MR: !$CI_MERGE_REQUEST_IID"
      echo "  - Branch: $CI_COMMIT_REF_NAME"
      echo "  - Commit: $CI_COMMIT_SHORT_SHA"

      # Validar token
      if [ -z "$PREVIEW_DEPLOY_TOKEN" ]; then
        echo "‚ùå PREVIEW_DEPLOY_TOKEN n√£o configurado"
        echo "Configure no Group: Settings ‚Üí CI/CD ‚Üí Variables"
        exit 1
      fi

      # Disparar pipeline trigger no GitLab (100% nativo!)
      echo "üì° Disparando pipeline no cloud-foundation..."
      HTTP_CODE=$(curl -w "%{http_code}" -o /tmp/response.json -X POST \
        -H "Content-Type: application/json" \
        "https://gitlab.com/api/v4/projects/m3nura%2Fcloud-foundation/trigger/pipeline" \
        -d @- <<EOF
      {
        "token": "$PREVIEW_DEPLOY_TOKEN",
        "ref": "main",
        "variables": {
          "TRIGGER_SOURCE": "preview-deploy",
          "SOURCE_REPO": "$CI_PROJECT_PATH",
          "SOURCE_REPO_NAME": "$CI_PROJECT_NAME",
          "MR_NUMBER": "$CI_MERGE_REQUEST_IID",
          "BRANCH": "$CI_COMMIT_REF_NAME",
          "COMMIT_SHA": "$CI_COMMIT_SHA",
          "ARTIFACT_NAME": "$EPHEMERAL_ARTIFACT",
          "ARTIFACT_URL": "$CI_PIPELINE_URL",
          "PREVIEW_ID": "$PREVIEW_ID",
          "ENVIRONMENT": "sandbox",
          "TRIGGERED_BY": "$GITLAB_USER_LOGIN",
          "GITLAB_PROJECT_URL": "$CI_PROJECT_URL",
          "GITLAB_MR_URL": "$CI_MERGE_REQUEST_PROJECT_URL/-/merge_requests/$CI_MERGE_REQUEST_IID"
        }
      }
      EOF
      )

      if [ "$HTTP_CODE" -eq 201 ]; then
        PIPELINE_ID=$(jq -r '.id' /tmp/response.json)
        PIPELINE_URL=$(jq -r '.web_url' /tmp/response.json)

        echo "‚úÖ Pipeline disparada com sucesso no cloud-foundation!"
        echo ""
        echo "üîó Links √∫teis:"
        echo "  - MR: $CI_MERGE_REQUEST_PROJECT_URL/-/merge_requests/$CI_MERGE_REQUEST_IID"
        echo "  - Pipeline (origem): $CI_PIPELINE_URL"
        echo "  - Pipeline (foundation): $PIPELINE_URL"
        echo ""
        echo "‚è≥ Aguarde o deploy completar no cloud-foundation..."
        echo "üì¶ Preview estar√° dispon√≠vel em alguns minutos"
      else
        echo "‚ùå Erro ao disparar pipeline (HTTP $HTTP_CODE)"
        cat /tmp/response.json
        exit 1
      fi
  environment:
    name: preview/mr-$CI_MERGE_REQUEST_IID
    url: https://preview-mr-$CI_MERGE_REQUEST_IID.sandbox.menura.com
    on_stop: stop_preview
    auto_stop_in: 7 days
    deployment_tier: development
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: manual  # APROVA√á√ÉO MANUAL NATIVA!
  needs:
    - job: build
      artifacts: true

.preview-deploy:
  extends: .preview-deploy-base

.stop-preview:
  stage: deploy
  image: alpine:latest
  script:
    - |
      echo "üßπ Limpando preview environment mr-$CI_MERGE_REQUEST_IID"
      echo ""
      echo "‚ÑπÔ∏è  O environment ser√° marcado como stopped"
      echo "‚ÑπÔ∏è  Preview ser√° removido automaticamente ap√≥s 7 dias (auto_stop_in)"
      echo ""
      echo "‚úÖ Cleanup conclu√≠do"
  environment:
    name: preview/mr-$CI_MERGE_REQUEST_IID
    action: stop
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: manual
  needs: []
  allow_failure: true
