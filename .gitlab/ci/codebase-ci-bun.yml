# =============================================================================
# CI - Continuous Integration para Bun (Reusable Pipeline)
# =============================================================================
# Pipeline reutiliz√°vel para projetos Bun da organiza√ß√£o Menura.
# Executa lint, testes e build com cache otimizado.
# =============================================================================

.bun-base:
  image: oven/bun:${BUN_VERSION}
  cache:
    key:
      files:
        - bun.lockb
    paths:
      - node_modules/
  before_script:
    - |
      # Validar vari√°veis obrigat√≥rias
      if [ -z "$BUN_VERSION" ]; then
        echo "‚ùå BUN_VERSION n√£o definido"
        echo "Configure: variables.BUN_VERSION no seu .gitlab-ci.yml"
        echo "Exemplo: BUN_VERSION: \"latest\" ou BUN_VERSION: \"1.0.0\""
        exit 1
      fi
    - bun install --frozen-lockfile

.bun-lint:
  extends: .bun-base
  stage: test
  script:
    - echo "üîç Lint - Verificando c√≥digo"
    - bun run lint
    - echo "‚úÖ Lint conclu√≠do!"
  rules:
    - if: '$SKIP_LINT == "true"'
      when: never
    - when: on_success
  allow_failure: false

.bun-test:
  extends: .bun-base
  stage: test
  script:
    - echo "üß™ Testes - Executando testes"
    - bun test
    - echo "‚úÖ Testes conclu√≠dos!"
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    when: always
    expire_in: 7 days
  rules:
    - if: '$SKIP_TESTS == "true"'
      when: never
    - when: on_success
  allow_failure: false

.bun-build:
  extends: .bun-base
  stage: build
  before_script:
    - bun install --frozen-lockfile
    - apk add --no-cache zip
  script:
    - |
      echo "üìã Build - Validando configura√ß√£o"

      # Validar vari√°veis obrigat√≥rias ANTES do build
      if [ -z "$ARTIFACT_PATH" ]; then
        echo "‚ùå ARTIFACT_PATH n√£o definido"
        echo "Configure: variables.ARTIFACT_PATH no seu .gitlab-ci.yml"
        echo "Exemplo: ARTIFACT_PATH: \"dist\" ou ARTIFACT_PATH: \"build\""
        exit 1
      fi

      if [ -z "$ARTIFACT_NAME" ]; then
        echo "‚ùå ARTIFACT_NAME n√£o definido"
        echo "Configure: variables.ARTIFACT_NAME no seu .gitlab-ci.yml"
        echo "Exemplo: ARTIFACT_NAME: \"meu-app\""
        exit 1
      fi

      echo "‚úÖ Configura√ß√£o validada"
    - echo "üî® Build - Compilando projeto"
    - bun run build
    - echo "‚úÖ Build conclu√≠do"
    - |
      # Criar zip do artefato com nome √∫nico
      BUILD_PATH="$ARTIFACT_PATH"
      TIMESTAMP=$(date +%s)
      ZIP_NAME="${ARTIFACT_NAME}-${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}-${TIMESTAMP}.zip"

      echo "üì¶ Criando arquivo compactado: $ZIP_NAME"
      echo "üìÅ Conte√∫do do diret√≥rio: $BUILD_PATH"

      # Validar se o diret√≥rio existe
      if [ ! -d "$BUILD_PATH" ]; then
        echo "‚ùå Diret√≥rio $BUILD_PATH n√£o encontrado"
        exit 1
      fi

      # Criar zip com conte√∫do direto na raiz (sem pasta pai)
      cd "$BUILD_PATH"
      zip -r "../$ZIP_NAME" . -x "*.git*"
      cd ..

      echo "‚úÖ Arquivo criado: $ZIP_NAME ($(du -h $ZIP_NAME | cut -f1))"
  artifacts:
    name: "$ARTIFACT_NAME-$CI_COMMIT_REF_SLUG-$CI_COMMIT_SHORT_SHA"
    paths:
      - "*.zip"
    expire_in: 7 days
  rules:
    - if: '$SKIP_BUILD == "true"'
      when: never
    - when: on_success
