# =============================================================================
# CI - Continuous Integration para Node.js (Reusable Pipeline)
# =============================================================================
# Pipeline reutiliz√°vel para projetos Node.js da organiza√ß√£o Menura.
# Executa lint, testes e build com cache otimizado.
# =============================================================================

.node-base:
  image: node:${NODE_VERSION}
  cache:
    key:
      files:
        - package-lock.json
    paths:
      - node_modules/
      - .npm/
  before_script:
    - |
      # Validar vari√°veis obrigat√≥rias
      if [ -z "$NODE_VERSION" ]; then
        echo "‚ùå NODE_VERSION n√£o definido"
        echo "Configure: variables.NODE_VERSION no seu .gitlab-ci.yml"
        echo "Exemplo: NODE_VERSION: \"20\""
        exit 1
      fi
    - npm ci --cache .npm --prefer-offline

.node-lint:
  extends: .node-base
  stage: test
  script:
    - echo "üîç Lint - Verificando c√≥digo"
    - npm run lint
    - echo "‚úÖ Lint conclu√≠do!"
  rules:
    - if: '$SKIP_LINT == "true"'
      when: never
    - when: on_success
  allow_failure: false

.node-test:
  extends: .node-base
  stage: test
  script:
    - echo "üß™ Testes - Executando testes"
    - npm test
    - echo "‚úÖ Testes conclu√≠dos!"
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    when: always
    reports:
      junit: junit.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
    expire_in: 7 days
  rules:
    - if: '$SKIP_TESTS == "true"'
      when: never
    - when: on_success
  allow_failure: false

.node-build:
  extends: .node-base
  stage: build
  before_script:
    # Instalar depend√™ncias do sistema (zip)
    - apt-get update -qq && apt-get install -y -qq zip > /dev/null 2>&1 || apk add --no-cache zip > /dev/null 2>&1
    - npm ci --cache .npm --prefer-offline
  script:
    - |
      echo "üìã Build - Validando configura√ß√£o"

      # Validar vari√°veis obrigat√≥rias ANTES do build
      if [ -z "$ARTIFACT_PATH" ]; then
        echo "‚ùå ARTIFACT_PATH n√£o definido"
        echo "Configure: variables.ARTIFACT_PATH no seu .gitlab-ci.yml"
        echo "Exemplo: ARTIFACT_PATH: \"dist\" ou ARTIFACT_PATH: \"build\""
        exit 1
      fi

      if [ -z "$ARTIFACT_NAME" ]; then
        echo "‚ùå ARTIFACT_NAME n√£o definido"
        echo "Configure: variables.ARTIFACT_NAME no seu .gitlab-ci.yml"
        echo "Exemplo: ARTIFACT_NAME: \"meu-app\""
        exit 1
      fi

      echo "‚úÖ Configura√ß√£o validada"
    - echo "üî® Build - Compilando projeto"
    - npm run build
    - echo "‚úÖ Build conclu√≠do"
    - |
      # Criar zip do artefato com nome √∫nico
      BUILD_PATH="$ARTIFACT_PATH"
      TIMESTAMP=$(date +%s)
      ZIP_NAME="${ARTIFACT_NAME}-${CI_COMMIT_REF_SLUG}-${CI_COMMIT_SHORT_SHA}-${TIMESTAMP}.zip"

      echo "üì¶ Criando arquivo compactado: $ZIP_NAME"
      echo "üìÅ Conte√∫do do diret√≥rio: $BUILD_PATH"

      # Validar se o diret√≥rio existe
      if [ ! -d "$BUILD_PATH" ]; then
        echo "‚ùå Diret√≥rio $BUILD_PATH n√£o encontrado"
        exit 1
      fi

      # Criar zip com conte√∫do direto na raiz (sem pasta pai)
      cd "$BUILD_PATH"
      zip -r "../$ZIP_NAME" . -x "*.git*"
      cd ..

      echo "‚úÖ Arquivo criado: $ZIP_NAME ($(du -h $ZIP_NAME | cut -f1))"
  artifacts:
    name: "$ARTIFACT_NAME-$CI_COMMIT_REF_SLUG-$CI_COMMIT_SHORT_SHA"
    paths:
      - "*.zip"
    expire_in: 7 days
  rules:
    - if: '$SKIP_BUILD == "true"'
      when: never
    - when: on_success