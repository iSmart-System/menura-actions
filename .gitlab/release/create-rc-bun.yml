# =============================================================================
# Create Release Candidate - Bun (Reusable Pipeline)
# =============================================================================
# Pipeline reutiliz√°vel para criar Release Candidates no ambiente sandbox.
# Executa build, gera artefato RC e dispara deploy no cloud-foundation.
# Execu√ß√£o manual via web UI, dispon√≠vel apenas na branch sandbox.
# =============================================================================

.create-rc-bun:
  stage: release
  image: oven/bun:${BUN_VERSION}
  cache:
    key:
      files:
        - bun.lockb
    paths:
      - node_modules/
  before_script:
    - apk add --no-cache git curl jq zip
    - git config user.name "GitLab CI"
    - git config user.email "ci@gitlab.com"
    - |
      # Validar vari√°veis obrigat√≥rias
      if [ -z "$BUN_VERSION" ]; then
        echo "‚ùå BUN_VERSION n√£o definido"
        exit 1
      fi
      if [ -z "$ARTIFACT_PATH" ]; then
        echo "‚ùå ARTIFACT_PATH n√£o definido"
        exit 1
      fi
      if [ -z "$ARTIFACT_NAME" ]; then
        echo "‚ùå ARTIFACT_NAME n√£o definido"
        exit 1
      fi
    - bun install --frozen-lockfile
  script:
    - |
      echo "üè∑Ô∏è  Criando Release Candidate (Bun)"
      echo ""

      # Validar RC_VERSION
      if [ -z "$RC_VERSION" ]; then
        echo "‚ùå RC_VERSION n√£o definida"
        echo ""
        echo "Configure a variable RC_VERSION antes de executar:"
        echo "  Exemplo: RC_VERSION=1.0.0-rc.1"
        echo ""
        echo "Formato: MAJOR.MINOR.PATCH-rc.NUMBER"
        exit 1
      fi

      # Validar formato
      if ! echo "$RC_VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+-rc\.[0-9]+$'; then
        echo "‚ùå Formato inv√°lido: $RC_VERSION"
        echo ""
        echo "Use o formato: MAJOR.MINOR.PATCH-rc.NUMBER"
        echo "  Exemplo: 1.0.0-rc.1"
        exit 1
      fi

      # Verificar se tag j√° existe
      if git rev-parse "v$RC_VERSION" >/dev/null 2>&1; then
        echo "‚ùå Tag v$RC_VERSION j√° existe"
        exit 1
      fi

      echo "üìã Release Candidate:"
      echo "  - Vers√£o: v$RC_VERSION"
      echo "  - Branch: $CI_COMMIT_REF_NAME"
      echo "  - Commit: $CI_COMMIT_SHORT_SHA"
      echo ""

    # STEP 1: Build
    - echo "üî® Executando build..."
    - bun run build
    - echo "‚úÖ Build conclu√≠do"
    - echo ""

    # STEP 2: Criar artefato RC
    - |
      echo "üì¶ Criando artefato RC..."
      BUILD_PATH="$ARTIFACT_PATH"
      TIMESTAMP=$(date +%s)
      ZIP_NAME="${ARTIFACT_NAME}-v${RC_VERSION}-${CI_COMMIT_SHORT_SHA}-${TIMESTAMP}.zip"

      echo "üìÅ Artefato: $ZIP_NAME"

      # Validar se o diret√≥rio existe
      if [ ! -d "$BUILD_PATH" ]; then
        echo "‚ùå Diret√≥rio $BUILD_PATH n√£o encontrado"
        exit 1
      fi

      # Criar zip com conte√∫do direto na raiz (sem pasta pai)
      cd "$BUILD_PATH"
      zip -r "../$ZIP_NAME" . -x "*.git*"
      cd ..

      echo "‚úÖ Artefato criado: $ZIP_NAME ($(du -h $ZIP_NAME | cut -f1))"
      echo ""

    # STEP 3: Criar tag RC
    - |
      echo "üè∑Ô∏è  Criando tag Git..."
      git tag -a "v$RC_VERSION" -m "Release Candidate $RC_VERSION

Created from: $CI_COMMIT_REF_NAME
Commit: $CI_COMMIT_SHA
Pipeline: $CI_PIPELINE_URL
Created by: $GITLAB_USER_LOGIN
Artifact: $ZIP_NAME"

      git push origin "v$RC_VERSION"
      echo "‚úÖ Tag v$RC_VERSION criada"
      echo ""

    # STEP 4: Trigger Cloud Foundation para deploy
    - |
      echo "üöÄ Disparando deploy no cloud-foundation..."

      # Validar token
      if [ -z "$CLOUD_FOUNDATION_TOKEN" ]; then
        echo "‚ö†Ô∏è  CLOUD_FOUNDATION_TOKEN n√£o configurado"
        echo "Deploy autom√°tico n√£o ser√° disparado"
        echo "Configure no Group: Settings ‚Üí CI/CD ‚Üí Variables"
      else
        # Montar URL do artefato (job artifacts)
        ARTIFACT_URL="$CI_PROJECT_URL/-/jobs/$CI_JOB_ID/artifacts/download"

        HTTP_CODE=$(curl -w "%{http_code}" -o /tmp/response.json -X POST \
          "https://gitlab.com/api/v4/projects/m3nura%2Fcloud-foundation/trigger/pipeline" \
          -d "token=$CLOUD_FOUNDATION_TOKEN" \
          -d "ref=main" \
          -d "variables[TRIGGER_SOURCE]=rc-deploy" \
          -d "variables[SOURCE_PROJECT]=$CI_PROJECT_PATH" \
          -d "variables[RC_VERSION]=v$RC_VERSION" \
          -d "variables[ARTIFACT_NAME]=$ZIP_NAME" \
          -d "variables[ARTIFACT_URL]=$ARTIFACT_URL" \
          -d "variables[ENVIRONMENT]=sandbox" \
          -d "variables[GITLAB_USER]=$GITLAB_USER_LOGIN")

        if [ "$HTTP_CODE" -eq 201 ]; then
          PIPELINE_ID=$(jq -r '.id' /tmp/response.json)
          PIPELINE_URL=$(jq -r '.web_url' /tmp/response.json)

          echo "‚úÖ Deploy disparado com sucesso!"
          echo ""
          echo "üîó Links:"
          echo "  - Tag: $CI_PROJECT_URL/-/tags/v$RC_VERSION"
          echo "  - Pipeline Deploy: $PIPELINE_URL"
        else
          echo "‚ùå Erro ao disparar deploy (HTTP $HTTP_CODE)"
          cat /tmp/response.json
          echo ""
          echo "‚ö†Ô∏è  Tag e artefato foram criados, mas deploy n√£o foi disparado"
        fi
      fi

      echo ""
      echo "‚úÖ Release Candidate v$RC_VERSION criada com sucesso!"
      echo ""
      echo "üìù Pr√≥ximos passos:"
      echo "  1. Aguarde o deploy completar no cloud-foundation"
      echo "  2. Valide a RC no ambiente sandbox"
      echo "  3. Se aprovada, qualifique para produ√ß√£o (branch main)"
  artifacts:
    name: "$ARTIFACT_NAME-v$RC_VERSION-$CI_COMMIT_SHORT_SHA"
    paths:
      - "*.zip"
    expire_in: 30 days  # RCs mantidas por mais tempo
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web" && $CI_COMMIT_REF_NAME == "sandbox"'
      when: manual
    - if: '$CI_COMMIT_REF_NAME == "sandbox"'
      when: manual
  only:
    - sandbox
  needs: []
