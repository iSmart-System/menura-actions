# =============================================================================
# Qualify Release (Reusable Pipeline)
# =============================================================================
# Pipeline reutiliz√°vel para qualificar Release Candidates para produ√ß√£o.
# Execu√ß√£o manual via web UI, dispon√≠vel apenas na branch main.
# =============================================================================

.qualify-release:
  stage: release
  image: alpine:latest
  before_script:
    - apk add --no-cache git curl jq
    - git config user.name "GitLab CI"
    - git config user.email "ci@gitlab.com"
  script:
    - |
      echo "‚úÖ Qualificando Release Candidate para Produ√ß√£o"
      echo ""

      # Validar RC tag
      if [ -z "$RC_TAG" ]; then
        echo "‚ùå RC_TAG n√£o definida"
        echo ""
        echo "Configure a variable RC_TAG antes de executar:"
        echo "  Exemplo: RC_TAG=v1.0.0-rc.1"
        echo ""
        echo "Formato: vMAJOR.MINOR.PATCH-rc.NUMBER"
        exit 1
      fi

      # Validar formato
      if ! echo "$RC_TAG" | grep -qE '^v[0-9]+\.[0-9]+\.[0-9]+-rc\.[0-9]+$'; then
        echo "‚ùå Formato inv√°lido: $RC_TAG"
        echo ""
        echo "Use o formato: vMAJOR.MINOR.PATCH-rc.NUMBER"
        echo "  Exemplo: v1.0.0-rc.1"
        exit 1
      fi

      # Verificar se RC tag existe
      if ! git rev-parse "$RC_TAG" >/dev/null 2>&1; then
        echo "‚ùå Tag $RC_TAG n√£o existe"
        echo ""
        echo "Tags dispon√≠veis:"
        git tag -l "v*-rc.*" | tail -5
        exit 1
      fi

      # Extrair vers√£o de produ√ß√£o (remover -rc.X)
      PROD_VERSION=$(echo "$RC_TAG" | sed 's/-rc\.[0-9]*$//')

      # Verificar se vers√£o de produ√ß√£o j√° existe
      if git rev-parse "$PROD_VERSION" >/dev/null 2>&1; then
        echo "‚ùå Tag $PROD_VERSION j√° existe"
        exit 1
      fi

      echo "üìã Qualificando Release:"
      echo "  - RC Tag: $RC_TAG"
      echo "  - Prod Version: $PROD_VERSION"
      echo "  - Branch: $CI_COMMIT_REF_NAME"
      echo ""

      # Buscar commit da RC
      RC_COMMIT=$(git rev-parse "$RC_TAG")
      RC_MESSAGE=$(git tag -l --format='%(contents)' "$RC_TAG")

      echo "üìù Release Candidate:"
      echo "$RC_MESSAGE"
      echo ""

      # Criar tag de produ√ß√£o no mesmo commit da RC
      git tag -a "$PROD_VERSION" "$RC_COMMIT" -m "Release $PROD_VERSION

Qualified from: $RC_TAG
Branch: $CI_COMMIT_REF_NAME
Pipeline: $CI_PIPELINE_URL
Qualified by: $GITLAB_USER_LOGIN

Original RC:
$RC_MESSAGE"

      # Push tag
      git push origin "$PROD_VERSION"

      echo ""
      echo "‚úÖ Release $PROD_VERSION qualificada e publicada!"
      echo ""
      echo "üîó Tag: $CI_PROJECT_URL/-/tags/$PROD_VERSION"
      echo ""
      echo "üìù Pr√≥ximos passos:"
      echo "  1. O pipeline de release ser√° disparado automaticamente"
      echo "  2. Artefatos ser√£o publicados no GitLab Releases"
      echo "  3. Deploy em produ√ß√£o ser√° iniciado"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web" && $CI_COMMIT_REF_NAME == "main"'
      when: manual
    - if: '$CI_COMMIT_REF_NAME == "main"'
      when: manual
  only:
    - main
  needs: []
