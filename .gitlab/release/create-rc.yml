# =============================================================================
# Create Release Candidate (Reusable Pipeline)
# =============================================================================
# Pipeline reutiliz√°vel para criar Release Candidates no ambiente sandbox.
# Execu√ß√£o manual via web UI, dispon√≠vel apenas na branch sandbox.
# =============================================================================

.create-release-candidate:
  stage: release
  image: alpine:latest
  before_script:
    - apk add --no-cache git curl jq
    - git config user.name "GitLab CI"
    - git config user.email "ci@gitlab.com"
  script:
    - |
      echo "üè∑Ô∏è  Criando Release Candidate"
      echo ""

      # Validar vers√£o
      if [ -z "$RC_VERSION" ]; then
        echo "‚ùå RC_VERSION n√£o definida"
        echo ""
        echo "Configure a variable RC_VERSION antes de executar:"
        echo "  Exemplo: RC_VERSION=1.0.0-rc.1"
        echo ""
        echo "Formato: MAJOR.MINOR.PATCH-rc.NUMBER"
        exit 1
      fi

      # Validar formato
      if ! echo "$RC_VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+-rc\.[0-9]+$'; then
        echo "‚ùå Formato inv√°lido: $RC_VERSION"
        echo ""
        echo "Use o formato: MAJOR.MINOR.PATCH-rc.NUMBER"
        echo "  Exemplo: 1.0.0-rc.1"
        exit 1
      fi

      # Verificar se tag j√° existe
      if git rev-parse "v$RC_VERSION" >/dev/null 2>&1; then
        echo "‚ùå Tag v$RC_VERSION j√° existe"
        exit 1
      fi

      echo "üìã Criando Release Candidate:"
      echo "  - Vers√£o: v$RC_VERSION"
      echo "  - Branch: $CI_COMMIT_REF_NAME"
      echo "  - Commit: $CI_COMMIT_SHORT_SHA"
      echo ""

      # Criar tag
      git tag -a "v$RC_VERSION" -m "Release Candidate $RC_VERSION

Created from: $CI_COMMIT_REF_NAME
Commit: $CI_COMMIT_SHA
Pipeline: $CI_PIPELINE_URL
Created by: $GITLAB_USER_LOGIN"

      # Push tag
      git push origin "v$RC_VERSION"

      echo ""
      echo "‚úÖ Release Candidate v$RC_VERSION criada com sucesso!"
      echo ""
      echo "üîó Tag: $CI_PROJECT_URL/-/tags/v$RC_VERSION"
      echo ""
      echo "üìù Pr√≥ximos passos:"
      echo "  1. Valide a RC no ambiente sandbox"
      echo "  2. Se aprovada, qualifique para produ√ß√£o (branch main)"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web" && $CI_COMMIT_REF_NAME == "sandbox"'
      when: manual
    - if: '$CI_COMMIT_REF_NAME == "sandbox"'
      when: manual
  only:
    - sandbox
  needs: []
