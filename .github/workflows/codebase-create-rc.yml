# =============================================================================
# Create Release Candidate Tag (Reusable Workflow)
# =============================================================================
# Este workflow cria tags de Release Candidate automaticamente.
# Segue o padr√£o: vX.Y.Z-rc.N
# =============================================================================

name: Create RC Tag

on:
  workflow_call:
    inputs:
      version-type:
        description: 'Tipo de incremento de vers√£o'
        required: false
        type: string
        default: 'patch'
    outputs:
      tag:
        description: 'Tag criada'
        value: ${{ jobs.create-tag.outputs.tag }}
      version:
        description: 'Vers√£o criada'
        value: ${{ jobs.create-tag.outputs.version }}

  workflow_dispatch:
    inputs:
      version-type:
        description: 'Tipo de incremento de vers√£o'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
        default: 'patch'

jobs:
  validate:
    name: Validar Branch
    runs-on: ubuntu-latest
    steps:
      - name: Verificar branch
        run: |
          if [[ "${{ github.ref_name }}" != "sandbox" ]]; then
            echo "::error::Release Candidates s√≥ podem ser criados a partir da branch 'sandbox'"
            echo "Branch atual: ${{ github.ref_name }}"
            exit 1
          fi
          echo "‚úÖ Branch validada: sandbox"

  create-tag:
    name: Criar Tag RC
    needs: validate
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.create.outputs.tag }}
      version: ${{ steps.create.outputs.version }}

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configurar Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Calcular pr√≥xima vers√£o
        id: version
        run: |
          # Busca todas as tags
          git fetch --tags

          # Encontra a √∫ltima tag de release (sem -rc)
          LAST_RELEASE=$(git tag -l "v[0-9]*.[0-9]*.[0-9]*" --sort=-v:refname | grep -v "\-rc" | head -n 1 || echo "")

          if [ -z "$LAST_RELEASE" ]; then
            LAST_RELEASE="v0.0.0"
          fi

          echo "üì¶ √öltima release: $LAST_RELEASE"

          # Extrai major, minor, patch
          VERSION=${LAST_RELEASE#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

          # Incrementa baseado no tipo
          VERSION_TYPE="${{ inputs.version-type }}"
          case "$VERSION_TYPE" in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW_VERSION="v${MAJOR}.${MINOR}.${PATCH}"
          echo "üÜï Nova vers√£o base: $NEW_VERSION"

          # Encontra o pr√≥ximo n√∫mero RC para esta vers√£o
          LAST_RC=$(git tag -l "${NEW_VERSION}-rc.*" --sort=-v:refname | head -n 1 || echo "")

          if [ -z "$LAST_RC" ]; then
            RC_NUMBER=1
          else
            # Extrai o n√∫mero do RC
            RC_NUMBER=$(echo "$LAST_RC" | grep -oP "rc\.\K[0-9]+" || echo "0")
            RC_NUMBER=$((RC_NUMBER + 1))
          fi

          FINAL_TAG="${NEW_VERSION}-rc.${RC_NUMBER}"

          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "tag=$FINAL_TAG" >> $GITHUB_OUTPUT
          echo "üè∑Ô∏è Tag a ser criada: $FINAL_TAG"

      - name: Criar tag
        id: create
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          VERSION="${{ steps.version.outputs.version }}"

          echo "üè∑Ô∏è Criando tag: $TAG"

          # Cria a tag anotada
          git tag -a "$TAG" -m "Release Candidate: $TAG

          Criado automaticamente via GitHub Actions.

          Vers√£o base: $VERSION
          Branch: ${{ github.ref_name }}
          Commit: ${{ github.sha }}
          Autor: ${{ github.actor }}
          Data: $(date -u +"%Y-%m-%dT%H:%M:%SZ")
          "

          # Push da tag
          git push origin "$TAG"

          echo "tag=$TAG" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "‚úÖ Tag criada com sucesso: $TAG"

      - name: Criar GitHub Release
        uses: actions/github-script@v7
        with:
          script: |
            const tag = '${{ steps.create.outputs.tag }}';
            const version = '${{ steps.create.outputs.version }}';

            const release = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tag,
              name: `üöß Release Candidate: ${tag}`,
              body: `## Release Candidate

            Esta √© uma **Release Candidate** para a vers√£o \`${version}\`.

            ### ‚ö†Ô∏è Aten√ß√£o
            - Esta vers√£o est√° em **homologa√ß√£o** no ambiente sandbox
            - **N√ÉO** deve ser usada em produ√ß√£o
            - Ap√≥s valida√ß√£o, ser√° promovida para release de produ√ß√£o

            ### Informa√ß√µes
            - **Tag:** \`${tag}\`
            - **Vers√£o alvo:** \`${version}\`
            - **Branch:** \`${{ github.ref_name }}\`
            - **Commit:** \`${{ github.sha }}\`

            ### Pr√≥ximos passos
            1. Validar no ambiente sandbox
            2. Se OK, executar workflow "Qualify RC"
            3. Se NOK, criar nova RC com corre√ß√µes
            `,
              draft: false,
              prerelease: true
            });

            console.log(`‚úÖ Release criada: ${release.data.html_url}`);

      - name: Resumo
        run: |
          echo "## üè∑Ô∏è Release Candidate Criada" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Tag:** \`${{ steps.create.outputs.tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Vers√£o base:** \`${{ steps.create.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Pr√≥ximos passos" >> $GITHUB_STEP_SUMMARY
          echo "1. Validar no ambiente sandbox" >> $GITHUB_STEP_SUMMARY
          echo "2. Se aprovado, executar **Qualify RC**" >> $GITHUB_STEP_SUMMARY
