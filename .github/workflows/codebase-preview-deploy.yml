# =============================================================================
# Preview Deploy to Sandbox (Reusable Workflow)
# =============================================================================
# Este workflow permite deploy manual de preview de um PR no ambiente sandbox.
# Dispara o repositÃ³rio menura-cloud-foundation para fazer deploy efÃªmero.
# =============================================================================

name: Preview Deploy to Sandbox

on:
  workflow_call:
    inputs:
      artifact-name:
        description: 'Nome do artefato gerado (sem extensÃ£o)'
        required: true
        type: string
      pr-number:
        description: 'NÃºmero do Pull Request'
        required: true
        type: string
      repository-name:
        description: 'Nome do repositÃ³rio (ex: my-app)'
        required: true
        type: string
      branch-name:
        description: 'Nome da branch'
        required: true
        type: string
      environment:
        description: 'Nome do environment GitHub para aprovaÃ§Ã£o'
        required: false
        type: string
        default: 'sandbox-preview'
      foundation-repo:
        description: 'RepositÃ³rio de infraestrutura (owner/repo)'
        required: false
        type: string
        default: 'iSmart-System/menura-cloud-foundation'
    secrets:
      dispatch-token:
        description: 'PAT com acesso ao repositÃ³rio de infraestrutura'
        required: true

jobs:
  trigger-preview-deploy:
    name: Trigger Preview Deploy
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}

    steps:
      - name: Validar inputs
        run: |
          echo "ðŸ” Validando inputs..."

          if [[ -z "${{ inputs.artifact-name }}" ]]; then
            echo "::error::artifact-name nÃ£o pode ser vazio"
            exit 1
          fi

          if [[ ! "${{ inputs.pr-number }}" =~ ^[0-9]+$ ]]; then
            echo "::error::pr-number deve ser numÃ©rico"
            exit 1
          fi

          echo "âœ… Inputs vÃ¡lidos"

      - name: Preparar metadata
        id: metadata
        run: |
          # Cria nome Ãºnico para o artefato efÃªmero
          EPHEMERAL_ARTIFACT="${{ inputs.artifact-name }}-pr-${{ inputs.pr-number }}"

          # Cria identificador Ãºnico para o preview environment
          PREVIEW_ID="pr-${{ inputs.pr-number }}"

          # URL do artefato no GitHub Actions
          ARTIFACT_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          echo "ephemeral-artifact=$EPHEMERAL_ARTIFACT" >> $GITHUB_OUTPUT
          echo "preview-id=$PREVIEW_ID" >> $GITHUB_OUTPUT
          echo "artifact-url=$ARTIFACT_URL" >> $GITHUB_OUTPUT

          echo "ðŸ“¦ Artefato efÃªmero: $EPHEMERAL_ARTIFACT"
          echo "ðŸ”— Preview ID: $PREVIEW_ID"

      - name: Trigger Infrastructure Deploy
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.dispatch-token }}
          repository: ${{ inputs.foundation-repo }}
          event-type: preview-deploy
          client-payload: |
            {
              "source_repo": "${{ github.repository }}",
              "source_repo_name": "${{ inputs.repository-name }}",
              "pr_number": "${{ inputs.pr-number }}",
              "branch": "${{ inputs.branch-name }}",
              "commit_sha": "${{ github.sha }}",
              "artifact_name": "${{ steps.metadata.outputs.ephemeral-artifact }}",
              "artifact_url": "${{ steps.metadata.outputs.artifact-url }}",
              "preview_id": "${{ steps.metadata.outputs.preview-id }}",
              "environment": "sandbox",
              "triggered_by": "${{ github.actor }}"
            }

      - name: Comentar no PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ inputs.pr-number }};
            const previewId = '${{ steps.metadata.outputs.preview-id }}';
            const artifactName = '${{ steps.metadata.outputs.ephemeral-artifact }}';

            const comment = `## ðŸš€ Preview Deploy Solicitado

            Um deploy de preview foi disparado para o ambiente sandbox.

            ### Detalhes
            - **Preview ID:** \`${previewId}\`
            - **Artefato:** \`${artifactName}\`
            - **Branch:** \`${{ inputs.branch-name }}\`
            - **Commit:** \`${{ github.sha }}\`
            - **Solicitado por:** @${{ github.actor }}

            ### PrÃ³ximos Passos
            1. Aguarde o deploy no repositÃ³rio [menura-cloud-foundation](https://github.com/${{ inputs.foundation-repo }})
            2. Acesse o ambiente preview quando estiver pronto
            3. Teste as mudanÃ§as
            4. O preview serÃ¡ removido automaticamente quando o PR for fechado

            ---

            ðŸ”— [Ver workflow de deploy](https://github.com/${{ inputs.foundation-repo }}/actions)
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });

      - name: Resumo
        run: |
          echo "## ðŸš€ Preview Deploy Disparado" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### InformaÃ§Ãµes do Deploy" >> $GITHUB_STEP_SUMMARY
          echo "- **RepositÃ³rio Alvo:** \`${{ inputs.foundation-repo }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Preview ID:** \`${{ steps.metadata.outputs.preview-id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Artefato:** \`${{ steps.metadata.outputs.ephemeral-artifact }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **PR:** #${{ inputs.pr-number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ inputs.branch-name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Status" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Evento \`preview-deploy\` enviado para o repositÃ³rio de infraestrutura" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "O deploy serÃ¡ executado no repositÃ³rio [menura-cloud-foundation](https://github.com/${{ inputs.foundation-repo }}/actions)" >> $GITHUB_STEP_SUMMARY
