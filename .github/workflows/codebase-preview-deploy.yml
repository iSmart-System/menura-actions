# =============================================================================
# Preview Deploy to Sandbox (Reusable Workflow)
# =============================================================================
# Este workflow permite deploy manual de preview de um PR no ambiente sandbox.
# Dispara o repositÃ³rio menura-cloud-foundation para fazer deploy efÃªmero.
# =============================================================================

name: Preview Deploy to Sandbox

on:
  workflow_call:
    inputs:
      artifact-name:
        description: 'Nome do artefato gerado (sem extensÃ£o)'
        required: true
        type: string
      pr-number:
        description: 'NÃºmero do Pull Request'
        required: true
        type: string
      repository-name:
        description: 'Nome do repositÃ³rio (ex: my-app)'
        required: true
        type: string
      branch-name:
        description: 'Nome da branch'
        required: true
        type: string
      issue-title:
        description: 'TÃ­tulo da issue de aprovaÃ§Ã£o'
        required: false
        type: string
        default: 'ðŸš€ AprovaÃ§Ã£o de Preview Deploy'
      foundation-repo:
        description: 'RepositÃ³rio de infraestrutura (owner/repo)'
        required: false
        type: string
        default: 'iSmart-System/menura-cloud-foundation'
    secrets:
      dispatch-token:
        description: 'PAT com acesso ao repositÃ³rio de infraestrutura'
        required: true

jobs:
  trigger-preview-deploy:
    name: Trigger Preview Deploy
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read

    steps:
      - name: Validar inputs
        run: |
          echo "ðŸ” Validando inputs..."

          if [[ -z "${{ inputs.artifact-name }}" ]]; then
            echo "::error::artifact-name nÃ£o pode ser vazio"
            exit 1
          fi

          if [[ ! "${{ inputs.pr-number }}" =~ ^[0-9]+$ ]]; then
            echo "::error::pr-number deve ser numÃ©rico"
            exit 1
          fi

          echo "âœ… Inputs vÃ¡lidos"

      - name: Definir configuraÃ§Ãµes de aprovaÃ§Ã£o
        id: approval-config
        run: |
          # Usa SEMPRE as variables da organizaÃ§Ã£o (governanÃ§a centralizada)
          APPROVERS="${{ vars.PREVIEW_DEPLOY_APPROVERS }}"
          MIN_APPROVALS="${{ vars.PREVIEW_DEPLOY_MINIMUM_APPROVALS }}"

          # Validar aprovadores
          if [[ -z "$APPROVERS" ]]; then
            echo "::error::PREVIEW_DEPLOY_APPROVERS nÃ£o configurada na organizaÃ§Ã£o!"
            echo "::error::Configure com: gh variable set PREVIEW_DEPLOY_APPROVERS --org iSmart-System --body 'user1,user2' --visibility all"
            exit 1
          fi

          # Validar mÃ­nimo de aprovaÃ§Ãµes
          if [[ -z "$MIN_APPROVALS" ]]; then
            echo "::error::PREVIEW_DEPLOY_MINIMUM_APPROVALS nÃ£o configurada na organizaÃ§Ã£o!"
            echo "::error::Configure com: gh variable set PREVIEW_DEPLOY_MINIMUM_APPROVALS --org iSmart-System --body '2' --visibility all"
            exit 1
          fi

          echo "ðŸ“‹ Aprovadores da organizaÃ§Ã£o: $APPROVERS"
          echo "ðŸ”¢ MÃ­nimo de aprovaÃ§Ãµes: $MIN_APPROVALS"

          echo "approvers=$APPROVERS" >> $GITHUB_OUTPUT
          echo "minimum-approvals=$MIN_APPROVALS" >> $GITHUB_OUTPUT

      - name: Preparar metadata
        id: metadata
        run: |
          # Cria nome Ãºnico para o artefato efÃªmero
          EPHEMERAL_ARTIFACT="${{ inputs.artifact-name }}-pr-${{ inputs.pr-number }}"

          # Cria identificador Ãºnico para o preview environment
          PREVIEW_ID="pr-${{ inputs.pr-number }}"

          # URL do artefato no GitHub Actions
          ARTIFACT_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          echo "ephemeral-artifact=$EPHEMERAL_ARTIFACT" >> $GITHUB_OUTPUT
          echo "preview-id=$PREVIEW_ID" >> $GITHUB_OUTPUT
          echo "artifact-url=$ARTIFACT_URL" >> $GITHUB_OUTPUT

          echo "ðŸ“¦ Artefato efÃªmero: $EPHEMERAL_ARTIFACT"
          echo "ðŸ”— Preview ID: $PREVIEW_ID"

      - name: Aguardar AprovaÃ§Ã£o Manual
        uses: trstringer/manual-approval@v1
        timeout-minutes: 60
        with:
          secret: ${{ github.token }}
          approvers: ${{ steps.approval-config.outputs.approvers }}
          minimum-approvals: ${{ steps.approval-config.outputs.minimum-approvals }}
          issue-title: ${{ inputs.issue-title }}
          issue-body: |
            ## ðŸš€ SolicitaÃ§Ã£o de Preview Deploy

            **PR #${{ inputs.pr-number }}** estÃ¡ solicitando deploy de preview no ambiente sandbox.

            ### ðŸ“‹ Detalhes
            - **RepositÃ³rio:** `${{ github.repository }}`
            - **Branch:** `${{ inputs.branch-name }}`
            - **Commit:** `${{ github.sha }}`
            - **Artefato:** `${{ steps.metadata.outputs.ephemeral-artifact }}`
            - **Preview ID:** `${{ steps.metadata.outputs.preview-id }}`
            - **Solicitado por:** @${{ github.actor }}

            ### ðŸ” AprovaÃ§Ã£o NecessÃ¡ria

            Para **aprovar** este preview deploy, comente:
            ```
            approved
            ```

            Para **negar** este preview deploy, comente:
            ```
            denied
            ```

            ---

            â±ï¸ **Timeout:** 60 minutos
            ðŸ‘¥ **AprovaÃ§Ãµes necessÃ¡rias:** ${{ steps.approval-config.outputs.minimum-approvals }}
            âœ… **Aprovadores:** ${{ steps.approval-config.outputs.approvers }}

            ðŸ”— [Ver PR #${{ inputs.pr-number }}](https://github.com/${{ github.repository }}/pull/${{ inputs.pr-number }})
            ðŸ”— [Ver Workflow Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

      - name: Trigger Infrastructure Deploy
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.dispatch-token }}
          repository: ${{ inputs.foundation-repo }}
          event-type: preview-deploy
          client-payload: |
            {
              "source_repo": "${{ github.repository }}",
              "source_repo_name": "${{ inputs.repository-name }}",
              "pr_number": "${{ inputs.pr-number }}",
              "branch": "${{ inputs.branch-name }}",
              "commit_sha": "${{ github.sha }}",
              "artifact_name": "${{ steps.metadata.outputs.ephemeral-artifact }}",
              "artifact_url": "${{ steps.metadata.outputs.artifact-url }}",
              "preview_id": "${{ steps.metadata.outputs.preview-id }}",
              "environment": "sandbox",
              "triggered_by": "${{ github.actor }}"
            }

      - name: Comentar no PR
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ inputs.pr-number }};
            const previewId = '${{ steps.metadata.outputs.preview-id }}';
            const artifactName = '${{ steps.metadata.outputs.ephemeral-artifact }}';

            const comment = `## ðŸš€ Preview Deploy Solicitado

            Um deploy de preview foi disparado para o ambiente sandbox.

            ### Detalhes
            - **Preview ID:** \`${previewId}\`
            - **Artefato:** \`${artifactName}\`
            - **Branch:** \`${{ inputs.branch-name }}\`
            - **Commit:** \`${{ github.sha }}\`
            - **Solicitado por:** @${{ github.actor }}

            ### PrÃ³ximos Passos
            1. Aguarde o deploy no repositÃ³rio [menura-cloud-foundation](https://github.com/${{ inputs.foundation-repo }})
            2. Acesse o ambiente preview quando estiver pronto
            3. Teste as mudanÃ§as
            4. O preview serÃ¡ removido automaticamente quando o PR for fechado

            ---

            ðŸ”— [Ver workflow de deploy](https://github.com/${{ inputs.foundation-repo }}/actions)
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: comment
            });

      - name: Resumo
        run: |
          echo "## ðŸš€ Preview Deploy Disparado" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### InformaÃ§Ãµes do Deploy" >> $GITHUB_STEP_SUMMARY
          echo "- **RepositÃ³rio Alvo:** \`${{ inputs.foundation-repo }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Preview ID:** \`${{ steps.metadata.outputs.preview-id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Artefato:** \`${{ steps.metadata.outputs.ephemeral-artifact }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **PR:** #${{ inputs.pr-number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ inputs.branch-name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Status" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Evento \`preview-deploy\` enviado para o repositÃ³rio de infraestrutura" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "O deploy serÃ¡ executado no repositÃ³rio [menura-cloud-foundation](https://github.com/${{ inputs.foundation-repo }}/actions)" >> $GITHUB_STEP_SUMMARY
