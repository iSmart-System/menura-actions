# =============================================================================
# Validate Tag (Reusable Workflow)
# =============================================================================
# Este workflow valida a nomenclatura de tags seguindo o padrÃ£o SemVer.
# Ã‰ executado automaticamente quando uma tag Ã© criada.
# =============================================================================

name: Validate Tag

on:
  workflow_call:

  push:
    tags:
      - 'v*'

jobs:
  validate:
    name: Validar Nomenclatura da Tag
    runs-on: ubuntu-latest
    outputs:
      is-valid: ${{ steps.validate.outputs.is-valid }}
      tag-type: ${{ steps.validate.outputs.tag-type }}
      version: ${{ steps.validate.outputs.version }}

    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validar tag
        id: validate
        run: |
          TAG="${{ github.ref_name }}"

          echo "ðŸ·ï¸ Validando tag: $TAG"

          # Regex para tag de produÃ§Ã£o: vX.Y.Z
          PROD_REGEX="^v[0-9]+\.[0-9]+\.[0-9]+$"

          # Regex para tag RC: vX.Y.Z-rc.N
          RC_REGEX="^v[0-9]+\.[0-9]+\.[0-9]+-rc\.[0-9]+$"

          # Regex genÃ©rica para qualquer tag vÃ¡lida
          VALID_REGEX="^v[0-9]+\.[0-9]+\.[0-9]+(-rc\.[0-9]+)?$"

          if [[ "$TAG" =~ $PROD_REGEX ]]; then
            echo "âœ… Tag de produÃ§Ã£o vÃ¡lida: $TAG"
            echo "is-valid=true" >> $GITHUB_OUTPUT
            echo "tag-type=production" >> $GITHUB_OUTPUT
            echo "version=$TAG" >> $GITHUB_OUTPUT

          elif [[ "$TAG" =~ $RC_REGEX ]]; then
            echo "âœ… Tag de Release Candidate vÃ¡lida: $TAG"
            echo "is-valid=true" >> $GITHUB_OUTPUT
            echo "tag-type=rc" >> $GITHUB_OUTPUT
            # Extrai versÃ£o base
            VERSION=$(echo "$TAG" | sed 's/-rc\.[0-9]*$//')
            echo "version=$VERSION" >> $GITHUB_OUTPUT

          else
            echo "::error::Tag invÃ¡lida: $TAG"
            echo ""
            echo "Formatos vÃ¡lidos:"
            echo "  - ProduÃ§Ã£o: vX.Y.Z (ex: v1.2.3)"
            echo "  - RC: vX.Y.Z-rc.N (ex: v1.2.3-rc.1)"
            echo ""
            echo "is-valid=false" >> $GITHUB_OUTPUT
            echo "tag-type=invalid" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: Verificar branch de origem
        run: |
          TAG="${{ github.ref_name }}"
          TAG_TYPE="${{ steps.validate.outputs.tag-type }}"

          # Encontra a branch que contÃ©m o commit da tag
          BRANCHES=$(git branch -r --contains "${{ github.sha }}" | sed 's/origin\///' | tr -d ' ')

          echo "ðŸ“ Branches que contÃªm este commit:"
          echo "$BRANCHES"

          if [[ "$TAG_TYPE" == "production" ]]; then
            if ! echo "$BRANCHES" | grep -q "^main$"; then
              echo "::warning::Tag de produÃ§Ã£o criada fora da branch main"
              echo "RecomendaÃ§Ã£o: Tags de produÃ§Ã£o devem ser criadas a partir de main"
            fi
          elif [[ "$TAG_TYPE" == "rc" ]]; then
            if ! echo "$BRANCHES" | grep -q "^sandbox$"; then
              echo "::warning::Tag RC criada fora da branch sandbox"
              echo "RecomendaÃ§Ã£o: Tags RC devem ser criadas a partir de sandbox"
            fi
          fi

      - name: Verificar sequÃªncia de versÃµes
        run: |
          TAG="${{ github.ref_name }}"
          VERSION="${{ steps.validate.outputs.version }}"
          TAG_TYPE="${{ steps.validate.outputs.tag-type }}"

          echo "ðŸ“Š Verificando sequÃªncia de versÃµes..."

          # Busca tags existentes
          git fetch --tags

          if [[ "$TAG_TYPE" == "production" ]]; then
            # Para produÃ§Ã£o, verifica se jÃ¡ existe RC para esta versÃ£o
            RC_EXISTS=$(git tag -l "${VERSION}-rc.*" | head -n 1 || echo "")

            if [ -z "$RC_EXISTS" ]; then
              echo "::warning::Nenhuma tag RC encontrada para a versÃ£o $VERSION"
              echo "RecomendaÃ§Ã£o: VersÃµes de produÃ§Ã£o devem passar por RC primeiro"
            else
              echo "âœ… Tag RC encontrada: $RC_EXISTS"
            fi
          fi

          # Lista Ãºltimas tags para contexto
          echo ""
          echo "ðŸ“‹ Ãšltimas tags:"
          git tag -l "v*" --sort=-v:refname | head -n 10

      - name: Resumo
        run: |
          TAG="${{ github.ref_name }}"
          TAG_TYPE="${{ steps.validate.outputs.tag-type }}"
          VERSION="${{ steps.validate.outputs.version }}"

          if [[ "$TAG_TYPE" == "production" ]]; then
            EMOJI="ðŸš€"
            TYPE_DESC="ProduÃ§Ã£o"
          elif [[ "$TAG_TYPE" == "rc" ]]; then
            EMOJI="ðŸš§"
            TYPE_DESC="Release Candidate"
          else
            EMOJI="âŒ"
            TYPE_DESC="InvÃ¡lida"
          fi

          echo "## $EMOJI ValidaÃ§Ã£o de Tag" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Campo | Valor |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Tag** | \`$TAG\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Tipo** | $TYPE_DESC |" >> $GITHUB_STEP_SUMMARY
          echo "| **VersÃ£o base** | \`$VERSION\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Autor** | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
