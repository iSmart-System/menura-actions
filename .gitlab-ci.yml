# =============================================================================
# Menura Pipelines - Templates Reutiliz√°veis GitLab CI/CD
# =============================================================================
# Este arquivo define templates reutiliz√°veis para projetos da organiza√ß√£o Menura.
# Projetos podem incluir estes templates usando 'include' e estend√™-los com 'extends'.
# =============================================================================

# IMPORTANTE: Este arquivo n√£o executa nada por si s√≥.
# Ele serve apenas como biblioteca de templates para outros projetos.

# =============================================================================
# TEMPLATES DE CI - NODE.JS
# =============================================================================

.node-base:
  image: node:${NODE_VERSION}
  cache:
    key:
      files:
        - package-lock.json
    paths:
      - node_modules/
      - .npm/
  before_script:
    - npm ci --cache .npm --prefer-offline

.node-lint:
  extends: .node-base
  stage: test
  script:
    - npm run lint
  rules:
    - if: '$SKIP_LINT == "true"'
      when: never
    - when: on_success

.node-test:
  extends: .node-base
  stage: test
  script:
    - npm test
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    when: always
    reports:
      junit: junit.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage/cobertura-coverage.xml
  rules:
    - if: '$SKIP_TESTS == "true"'
      when: never
    - when: on_success

.node-build:
  extends: .node-base
  stage: build
  script:
    - npm run build
  artifacts:
    name: "build-$CI_COMMIT_REF_SLUG"
    paths:
      - ${ARTIFACT_PATH:-dist}/
      - ${ARTIFACT_PATH:-build}/
    expire_in: 7 days
  rules:
    - if: '$SKIP_BUILD == "true"'
      when: never
    - when: on_success

# =============================================================================
# TEMPLATES DE CI - BUN
# =============================================================================

.bun-base:
  image: oven/bun:${BUN_VERSION:-latest}
  cache:
    key:
      files:
        - bun.lockb
    paths:
      - node_modules/
  before_script:
    - bun install --frozen-lockfile

.bun-lint:
  extends: .bun-base
  stage: test
  script:
    - bun run lint
  rules:
    - if: '$SKIP_LINT == "true"'
      when: never
    - when: on_success

.bun-test:
  extends: .bun-base
  stage: test
  script:
    - bun test
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  rules:
    - if: '$SKIP_TESTS == "true"'
      when: never
    - when: on_success

.bun-build:
  extends: .bun-base
  stage: build
  script:
    - bun run build
  artifacts:
    name: "build-$CI_COMMIT_REF_SLUG"
    paths:
      - ${ARTIFACT_PATH:-dist}/
      - ${ARTIFACT_PATH:-build}/
    expire_in: 7 days
  rules:
    - if: '$SKIP_BUILD == "true"'
      when: never
    - when: on_success

# =============================================================================
# TEMPLATES DE DEPLOY - PREVIEW ENVIRONMENTS
# =============================================================================

.preview-deploy-base:
  stage: deploy
  image: alpine:latest
  before_script:
    - apk add --no-cache curl jq
  script:
    - |
      echo "üöÄ Disparando preview deploy para $FOUNDATION_REPO"

      # Validar inputs obrigat√≥rios
      if [ -z "$ARTIFACT_NAME" ]; then
        echo "‚ùå ARTIFACT_NAME n√£o definido"
        exit 1
      fi

      if [ -z "$CI_MERGE_REQUEST_IID" ]; then
        echo "‚ùå Apenas dispon√≠vel em Merge Requests"
        exit 1
      fi

      # Preparar payload
      PREVIEW_ID="mr-$CI_MERGE_REQUEST_IID"
      EPHEMERAL_ARTIFACT="$ARTIFACT_NAME-mr-$CI_MERGE_REQUEST_IID"

      # Usar repository_dispatch do GitHub (tempor√°rio at√© foundation migrar)
      curl -X POST \
        -H "Authorization: token $PREVIEW_DEPLOY_TOKEN" \
        -H "Accept: application/vnd.github.v3+json" \
        "https://api.github.com/repos/${FOUNDATION_REPO}/dispatches" \
        -d @- <<EOF
      {
        "event_type": "preview-deploy",
        "client_payload": {
          "source_repo": "$CI_PROJECT_PATH",
          "source_repo_name": "$CI_PROJECT_NAME",
          "mr_number": "$CI_MERGE_REQUEST_IID",
          "branch": "$CI_COMMIT_REF_NAME",
          "commit_sha": "$CI_COMMIT_SHA",
          "artifact_name": "$EPHEMERAL_ARTIFACT",
          "artifact_url": "$CI_PIPELINE_URL",
          "preview_id": "$PREVIEW_ID",
          "environment": "sandbox",
          "triggered_by": "$GITLAB_USER_LOGIN"
        }
      }
      EOF

      echo "‚úÖ Preview deploy disparado com sucesso!"
      echo "üì¶ Artefato: $EPHEMERAL_ARTIFACT"
      echo "üîó Preview ID: $PREVIEW_ID"
  environment:
    name: preview/mr-$CI_MERGE_REQUEST_IID
    url: https://preview-mr-$CI_MERGE_REQUEST_IID.sandbox.menura.com
    on_stop: stop_preview
    auto_stop_in: 7 days
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: manual  # APROVA√á√ÉO MANUAL NATIVA!
  needs:
    - job: build
      artifacts: true

.preview-deploy:
  extends: .preview-deploy-base
  variables:
    FOUNDATION_REPO: "iSmart-System/menura-cloud-foundation"

.stop-preview:
  stage: deploy
  image: alpine:latest
  script:
    - echo "üßπ Limpando preview environment mr-$CI_MERGE_REQUEST_IID"
    - echo "Preview ser√° removido automaticamente ap√≥s 7 dias"
  environment:
    name: preview/mr-$CI_MERGE_REQUEST_IID
    action: stop
  rules:
    - if: '$CI_PIPELINE_SOURCE == "merge_request_event"'
      when: manual
  needs: []

# =============================================================================
# TEMPLATES DE RELEASE
# =============================================================================

.create-release-candidate:
  stage: release
  image: alpine:latest
  before_script:
    - apk add --no-cache git curl jq
  script:
    - |
      echo "üè∑Ô∏è Criando Release Candidate"

      # Validar vers√£o
      if [ -z "$RC_VERSION" ]; then
        echo "‚ùå RC_VERSION n√£o definida (ex: 1.0.0-rc.1)"
        exit 1
      fi

      # Criar tag
      git tag -a "v$RC_VERSION" -m "Release Candidate $RC_VERSION"
      git push origin "v$RC_VERSION"

      echo "‚úÖ Release Candidate v$RC_VERSION criada com sucesso!"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web" && $CI_COMMIT_REF_NAME == "sandbox"'
      when: manual
  only:
    - sandbox

.qualify-release:
  stage: release
  image: alpine:latest
  before_script:
    - apk add --no-cache git curl jq
  script:
    - |
      echo "‚úÖ Qualificando Release Candidate para Produ√ß√£o"

      # Validar RC tag
      if [ -z "$RC_TAG" ]; then
        echo "‚ùå RC_TAG n√£o definida (ex: v1.0.0-rc.1)"
        exit 1
      fi

      # Extrair vers√£o sem -rc
      PROD_VERSION=$(echo "$RC_TAG" | sed 's/-rc\.[0-9]*$//')

      # Criar tag de produ√ß√£o
      git tag -a "$PROD_VERSION" -m "Release $PROD_VERSION"
      git push origin "$PROD_VERSION"

      echo "‚úÖ Release $PROD_VERSION qualificada e publicada!"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "web" && $CI_COMMIT_REF_NAME == "main"'
      when: manual
  only:
    - main

# =============================================================================
# STAGES PADR√ÉO
# =============================================================================
# Projetos devem definir seus pr√≥prios stages, mas estes s√£o recomendados:
#
# stages:
#   - test
#   - build
#   - deploy
#   - release
# =============================================================================
